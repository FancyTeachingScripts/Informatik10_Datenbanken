%\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{Schulaufgabe}[2020/01/21 Schulaufgabenumgebung]
\input{sty/packages}

\pagestyle{fancy}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% Variablendeklaration %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newboolean{Noten}
\setboolean{Noten}{false}
\newboolean{Antworten}
\setboolean{Antworten}{false}
\newboolean{Pkt}
\setboolean{Pkt}{false}
\newcounter{Punkte}
\setcounter{Punkte}{0}
\newcounter{PunkteG}
\setcounter{PunkteG}{0}
\newcounter{einsletzte}
\newcounter{zweiletzte}
\newcounter{dreiletzte}
\newcounter{vierletzte}
\newcounter{funfletzte}
\setcounter{einsletzte}{85}
\setcounter{zweiletzte}{70}
\setcounter{dreiletzte}{55}
\setcounter{vierletzte}{40}
\setcounter{funfletzte}{20}

\newcounter{i}
\newcount\N
\newcounter{Notenzeile}
\setcounter{Notenzeile}{0}

\newlength{\einsP}
\newlength{\zweiP}
\newlength{\dreiP}
\newlength{\vierP}
\newlength{\funfP}

\newarray\aPunkte
\aPunkte(0)={0}

\newlength{\karo}
\newlength{\xkaro}
\newlength{\ykaro}
\newcounter{xkar}
\newcounter{ykar}
\definecolor{hellgrau}{gray}{.6}

\def\fullcheckmark{\tikz\draw[scale=0.4,fill=black](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15)}

\def\halfcheckmark{\tikz\draw[scale=0.4,fill=black](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- cycle (0.75,0.2) -- (0.77,0.2)  -- (0.6,0.7) -- cycle;}

\def\quartcheckmark{\tikz\draw[scale=0.4,fill=black](0,.35) -- (.25,0) -- (1,.7) -- (.25,.15) -- 
cycle (0.65,0.1) -- (0.67,0.1)  -- (0.6,0.8) -- cycle  -- 
cycle (0.85,0.3) -- (0.87,0.2)  -- (0.8,0.9) -- cycle;}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%% Neue Befehle %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\graphicspath{{./img/}}

%Fach in der Überschrift
\newcommand{\Fach}[1]{\newcommand{\Fachtext}{#1}}
%Lehrer Matthias ergänzung
\newcommand{\Lehrer}[1]{\newcommand{\Lehrertext}{#1}}
\newcommand{\Lehrervorname}[1]{\newcommand{\Lehrervornametext}{#1}}
\newcommand{\Lehrernachname}[1]{\newcommand{\Lehrernachnametext}{#1}}
\newcommand{\Info}[1]{\newcommand{\Infotext}{#1}}
\newcommand{\Testart}[1]{\newcommand{\Testarttesttext}{#1}}
\newcommand{\Datum}[1]{\newcommand{\Datumtext}{#1}}
\newcommand{\Klasse}[1]{\newcommand{\Klassetext}{#1}}
\newcommand{\Nr}[1]{\newcommand{\Nrtext}{#1}}
\newcommand{\LoesungFarbe}[1]{\newcommand{\LFarbe}{#1}}

\newcommand{\Namenszeile}{
    \LARGE\begin{center}
	\ifthenelse
	{\boolean{Antworten}}
	{\color{ \LFarbe}Erwartungshorizont \\ \normalsize Korrektur-Symbole: \fullcheckmark 1BE, \halfcheckmark 0,5BE, \quartcheckmark 0,25BE; \Large \sout{V} \normalsize fehlt; \Large f \normalsize falsch; \large FF/WF \normalsize kein Abzug, da Folge-/Wiederholungsfehler\\BE-Summe wird aufgabenweise auf halbe BE abgerundet \color{black}}
	{
	    Vorname, Nachname:\rule{9cm}{0.1mm}\\
	    \vspace{0.25cm}\normalsize
	    \Infotext}
	\normalsize
	\end{center}
 }

\input{sty/Loesung}
	
	
\newcommand\maketabularrow[1]{%
\newcounter{colnum}
  \setcounter{colnum}{0}%
  \whileboolexpr
    { test {\ifnumcomp{\value{colnum}}{<}{#1}} }%
    {\stepcounter{colnum}\aPunkte(\value{colnum})~~~&}
  }
  
\newcommand\berechnung[1]{
\newdimen\prz
\newdimen\tmp
\tmp=1pt
\prz=#1\tmp
\divide\prz by 100
\newdimen\tmpzwei
\newcount\tmpdrei
\newcount\nk
\newcount\vk
\tmp=\value{PunkteG}\prz
\tmpzwei=\tmp
\vk=\tmp
\divide\vk by 65536
\tmpdrei=\vk
\multiply\tmpdrei by 65536
\nk=\tmp
\advance\nk by -\tmpdrei
\multiply\nk by 100
\divide\nk by 65536
\ifnum\nk<25
\nk=0
\else
\ifnum\nk<75
\nk=50
\else
\ifnum\nk>74
\nk=0
\advance\vk by 1
\fi
\fi
\fi
\the\vk,\the\nk
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% Optionen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Schrift OHNE Serifen
\DeclareOption{sans}{
	
	\renewcommand*\familydefault{\sfdefault} 
}

%Schrift MIT Serifen
\DeclareOption{roman}{
	\renewcommand{\familydefault}{\rmdefault}
}

%Abdrucken der Antworten
\DeclareOption{antworten}{%
	\setboolean{Antworten}{true}
}

%Abdruck des Notenschlüssels
\DeclareOption{noten}{%
	\setboolean{Noten}{true}
}

%Abdruck des Punktetabelle
\DeclareOption{punkte}{%
	\setboolean{Pkt}{true}
}

%% Global indentation option
\newif\if@neverindent\@neverindentfalse
\DeclareOption{neverindent}{
	\@neverindenttrue
}

\ExecuteOptions{roman}

\ProcessOptions\relax


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%% Dokumentenbeginn %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\AtBeginDocument{
	\begin{multicols}{2}
		\begin{center}
            \Large 
			\lhead{\ifnum\thepage=1 
			{\includegraphics[height=9mm]{sty/img/logo_\theme.pdf}}
			\else
			\Nrtext. \Testarttesttext \ in \Fachtext%Name:
			\fi}
			\rhead{
			\ifnum\thepage=1
			{
			\Datumtext \\
			Klasse \Klassetext \ (\Lehrernachnametext)}
			\else
			\fi
			}
			\chead{
			\ifnum\thepage=1
			{
			\Large
			\Nrtext. \Testarttesttext \ in \Fachtext \normalsize
			}
			\else
			\fi
			}
		\end{center}
	\end{multicols}		
	

			%\uline{\LARGE \Nrtext.\Testarttesttext\\ \LARGE{im Fach \Fachtext\\}}			
	\ifthenelse
        {\isundefined{\LFarbe}}
        {\newcommand{\LFarbe}{blue}}
        {}
			%\LARGE am \rule{.75cm}{.4pt}.\rule{.75cm}{.4pt}.\rule{1.5cm}{.4pt}
			\Namenszeile
            
	%\noindent\rule[1ex]{\textwidth}{.4pt}
}




\AtEndDocument{

	%\hfill~\hfill Gesamtpunktzahl: \thePunkte
	%\begin{center}
	%	\Huge Viel Erfolg,
		
	%	\Huge \Lehrernachnametext
	%\end{center}





\vfill
	\ifthenelse
	{\boolean{Noten}}
	{

\newcounter{zweierste}
\newcounter{dreierste}
\newcounter{viererste}
\newcounter{funferste}
\newcounter{secherste}
\setcounter{zweierste}{\theeinsletzte}
\setcounter{dreierste}{\thezweiletzte}
\setcounter{viererste}{\thedreiletzte}
\setcounter{funferste}{\thevierletzte}
\setcounter{secherste}{\thefunfletzte}
\addtocounter{zweierste}{-1}
\addtocounter{dreierste}{-1}
\addtocounter{viererste}{-1}
\addtocounter{funferste}{-1}
\addtocounter{secherste}{-1}

\noindent\textbf{Notenschlüssel}\\
\begin{tabularx}{\textwidth}{|C|C|C|C|C|C|}\hline
    1 & 2 & 3& 4& 5& 6 \\\hline
    100 - \theeinsletzte \% & \thezweierste - \thezweiletzte \% & \thedreierste - \thedreiletzte \% & \theviererste - \thevierletzte \% & \thefunferste - \thefunfletzte \% & \thesecherste - 0 \% \\ \hline
    \thePunkteG ~-~\berechnung{\theeinsletzte} & \berechnung{\thezweierste} - \berechnung{\thezweiletzte} & \berechnung{\thedreierste} - \berechnung{\thedreiletzte} & \berechnung{\theviererste} - \berechnung{\thevierletzte}  &  \berechnung{\thefunferste} - \berechnung{\thefunfletzte} & \berechnung{\thesecherste} - 0 \\ \hline
\end{tabularx}}{}

\ifthenelse
	{\boolean{Pkt}}
	{\LARGE

\noindent
\newtoks\cols
\newtoks\last

  \N=\value{Punkte}
  \setcounter{Notenzeile}{\value{Punkte}}
  \stepcounter{Notenzeile}
  \cols={}
  \last={}
  \setcounter{i}{1}
  \loop
    \cols=\expandafter{\the\expandafter\cols\the\value{i}}
  \ifnum\value{i}<\N
    \cols=\expandafter{\the\cols &}
    \last=\expandafter{\the\last&}
    \stepcounter{i}
  \repeat
  
\noindent\begin{tabularx}{\textwidth}{|*{\N}{C|}C|C|}\hline
    \the\cols & $\sum$ & Note\\\hline
    \maketabularrow{\N} \thePunkteG&\\\cline{1-\theNotenzeile}
    \the\last &&\\\hline
  \end{tabularx}
	}
	{}	

}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%% Neue Umgebungen %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\newenvironment{Aufgabe}[1][\unskip]
{\addtocounter{PunkteG}{#1}\stepcounter{Punkte}\aPunkte(\thePunkte)={#1}
\vspace{.1mm}\newcommand{\pkt}{#1}
\noindent~\hspace*{-10mm} \begin{tabular}{p{2mm}p{150mm}p{20mm}}
     \thePunkte.& 
} 
{& \hfill~\hfill~\framebox[1.1\width]{ ~~~~~ / ~\pkt~}~  \\
    \end{tabular}\vspace{2mm}}



%% Traditional LaTeX or TeX follows...
% ...

\newlength{\pardefault}
\setlength{\pardefault}{\parindent}
\newcommand{\neverindent}{ \setlength{\parindent}{0pt} }
\newcommand{\autoindent}{ \setlength{\parindent}{\pardefault} }

\if@neverindent
\neverindent
\fi

% ...

\endinput