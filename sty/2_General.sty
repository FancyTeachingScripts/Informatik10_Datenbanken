\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{sty/2_General}[]


\usetikzlibrary{shapes.geometric, arrows, positioning, shapes.geometric, arrows.meta, calc, bending,fadings}


\renewcommand{\umltextcolor}{\TFarbe}
\ifbeamer
    \renewcommand{\umlfillcolor}{black}
\else
    \renewcommand{\umlfillcolor}{white}
\fi
\renewcommand{\umldrawcolor}{\TFarbe}

\renewcommand{\emph}[1]{\textbf{#1}}
\providecommand{\currentsection}{\nameref{\thesection}}

\tikzstyle{startstop} = [rectangle, rounded corners, 
minimum width=2cm, 
minimum height=0.7cm,
text centered, 
draw=black]

\tikzstyle{io} = [trapezium, 
trapezium stretches=true, % A later addition
trapezium left angle=70, 
trapezium right angle=110, 
minimum width=2cm, 
minimum height=0.7cm, text centered, 
draw=black]

\tikzstyle{process} = [rectangle, 
minimum width=2cm, 
minimum height=0.7cm, 
text centered, 
text width=3cm, 
draw=black]

\tikzstyle{decision} = [diamond, 
minimum width=2cm, 
minimum height=1cm, 
text centered, 
draw=black]

\tikzstyle{arrow} = [thick,->,>=stealth]
\@ifundefined{NC@rewrite@C}{\newcolumntype{C}{>{\Centering\hspace{0pt}}X}}{}

\tikzstyle{dfddata} =[box, 
    rounded corners=1pt,  
    minimum width=1pt]

\tikzset{box/.style={draw, rectangle, rounded corners=3pt, align=center}}

\renewcommand{\uniAssociation}[5]{
    \draw[thick, -{Straight Barb[scale=2]}] 
        (#1) to 
            node[pos=0.05, below=2pt] {#2}
            node[midway, above]{#3}
            node[pos=0.93, below=2pt] {#4}
        (#5);
}
% \renewcommand{\uniAssociationAngle}[9]{%
%     % --- 1. Initialize empty macros ---
%     \def\assoc@verticalpos{}%
%     \def\assoc@horizontalpos{}%

%     % --- 2. Parse #3 and populate the macros ---
%     \ifstrequal{#3}{above}{\def\assoc@verticalpos{#3}}{}%
%     \ifstrequal{#3}{below}{\def\assoc@verticalpos{#3}}{}%
%     \ifstrequal{#3}{left}{\def\assoc@horizontalpos{#3}}{}%
%     \ifstrequal{#3}{right}{\def\assoc@horizontalpos{#3}}{}%

%     % --- 3. CORRECTED LOGIC to parse #7 ---
%     % Directly check the value of #7 and then see if the relevant macro is empty.
    
%     \ifstrequal{#7}{above}{ 
%         \ifstrequal{\assoc@verticalpos}{below}{
%             \def\assoc@verticalpos{}% TODO
%             \def\assoc@horizontalpos{}%
%         }{
%             \def\assoc@verticalpos{#7}
%         }
%     }{}%
    
%     \ifstrequal{#7}{below}{ 
%         \ifstrequal{\assoc@verticalpos}{above}{
%             \def\assoc@verticalpos{}% TODO
%             \def\assoc@horizontalpos{}%
%         }{
%             \def\assoc@verticalpos{#7}
%         }
%     }{}%
    
%     \ifstrequal{#7}{left}{ 
%         \ifstrequal{\assoc@horizontalpos}{right}{
%             \def\assoc@verticalpos{}% TODO
%             \def\assoc@horizontalpos{}%
%         }{
%             \def\assoc@horizontalpos{#7}
%         }
%     }{}%
    
%     \ifstrequal{#7}{right}{ 
%         \ifstrequal{\assoc@horizontalpos}{left}{
%             \def\assoc@verticalpos{}% TODO
%             \def\assoc@horizontalpos{}%
%         }{
%             \def\assoc@horizontalpos{#7}
%         }
%     }{}%

%     % --- 4. Safely build the final position string ---
%     \def\assoc@midwayspace{}%
%     \ifstrequal{\assoc@verticalpos}{below}{
%         \typeout{LOG: A}
%         \ifstrequal{\assoc@horizontalpos}{left}{
%             \typeout{LOG: B}
%             \def\assoc@midwayspace{\space}%
%         }{%
%             \typeout{LOG: C}
%             \ifstrequal{\assoc@horizontalpos}{right}{
%                 \def\assoc@midwayspace{\space}%
%             }{\typeout{LOG: D}}
%         }
%     }{\typeout{LOG: E}
%     \typeout{\assoc@verticalpos}
%         \ifstrequal{\assoc@verticalpos}{above}{
%             \typeout{LOG: F}
%             \ifstrequal{\assoc@horizontalpos}{left}{\typeout{LOG: G}
%                 \def\assoc@midwayspace{\space}%
%             }{\typeout{LOG: H}
%                 \ifstrequal{\assoc@horizontalpos}{right}{\typeout{LOG: I}
%                     \def\assoc@midwayspace{\space}%
%                 }{\typeout{LOG: J}}
%             }
%         }{\typeout{LOG: K}}
%     }
    
%     \edef\assoc@midwaypos{\assoc@verticalpos\assoc@midwayspace\assoc@horizontalpos}%

%     \typeout{LOG: '#3'+'#7'='\assoc@midwaypos'}
%     % --- 5. Draw the path ---
%     \draw[thick, -{Straight Barb[scale=2]}]
%         (#1) to
%             [out=#2, in=#8]
%             node[pos=0.05, #3=4pt] {#4}
%             node[midway, \assoc@midwaypos]{#5}
%             node[pos=0.93, #7=4pt] {#6}
%         (#9);
% }
\renewcommand{\uniAssociationAngle}[9]{%
    % --- 1. Initialize empty macros ---
    \typeout{LOG: '#3','#7'}

    % --- 2. Parse #3 and populate the macros ---
    \def\assoc@midwaypos{}%
    \ifstrequal{#3}{above}{    
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{above}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{left}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{above left}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{above right}%
        }{}%
    }{}%
    \ifstrequal{#3}{below}{
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{left}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{below}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{below left}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{below right}%
        }{}%
    }{}%
    \ifstrequal{#3}{left}{
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{above left}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{below left}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{left}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{above}%
        }{}%
    }{}%
    \ifstrequal{#3}{right}{
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{above right}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{below right}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{above}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{right}%
        }{}%
    }{}%
    
    \typeout{LOG: '\assoc@midwaypos'}
    % --- 5. Draw the path ---
    \draw[thick, -{Straight Barb[scale=2]}]
        (#1) to
            [out=#2, in=#8]
            node[pos=0.05, #3=4pt] {#4}
            node[midway, \assoc@midwaypos]{#5}
            node[pos=0.93, #7=4pt] {#6}
        (#9);
}
\renewcommand{\biAssociationAngle}[9]{%
    % --- 1. Initialize empty macros ---
    \typeout{LOG: '#3','#7'}

    % --- 2. Parse #3 and populate the macros ---
    \def\assoc@midwaypos{}%
    \ifstrequal{#3}{above}{    
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{above}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{left}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{above left}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{above right}%
        }{}%
    }{}%
    \ifstrequal{#3}{below}{
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{right}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{below}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{below left}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{below right}%
        }{}%
    }{}%
    \ifstrequal{#3}{left}{
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{above left}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{below left}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{left}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{below}%
        }{}%
    }{}%
    \ifstrequal{#3}{right}{
        \ifstrequal{#7}{above}{
            \def\assoc@midwaypos{above right}%
        }{}%
        \ifstrequal{#7}{below}{
            \def\assoc@midwaypos{below right}%
        }{}%
        \ifstrequal{#7}{left}{
            \def\assoc@midwaypos{above}%
        }{}%
        \ifstrequal{#7}{right}{
            \def\assoc@midwaypos{right}%
        }{}%
    }{}%
    
    \typeout{LOG: '\assoc@midwaypos'}
    % --- 5. Draw the path ---
    \draw[thick, -]
        (#1) to
            [out=#2, in=#8]
            node[pos=0.05, #3=4pt] {#4}
            node[midway, \assoc@midwaypos]{#5}
            node[pos=0.93, #7=4pt] {#6}
        (#9);
}


\renewcommand{\biAssociationSimple}[5]{
    \draw[thick, -] 
        (#1) to 
            node[pos=0.05, below=2pt] {#2}
            node[midway, above]{#3}
            node[pos=0.95, below=2pt] {#4}
        (#5);
}
\renewcommand{\biAssociation}[6]{
    \draw[thick, -] 
        (#1) to 
            node[pos=0.05, below] {#2}
            node[pos=0.05, above] {#3}
            node[pos=0.95, above] {#4}
            node[pos=0.95, below] {#5}
        (#6);
}


\newcommand\calcVerticalBoxes[2]{%
  % Resthöhe bestimmen
  \newdimen\resthoehe
  \resthoehe=\dimexpr\pagegoal-\pagetotal\relax
  % Falls wir ausserhalb des Seitenbaus sind: \pagegoal = \maxdimen → Fallback
  \ifdim\pagegoal=\maxdimen
    \resthoehe=\dimexpr\vsize-\pagetotal\relax
  \fi
  \typeout{pagegoal: \the\pagegoal}%
  \typeout{pagetotal: \the\pagetotal}
  \typeout{resthoehe: \the\resthoehe}%
  \typeout{maxdimen: \the\maxdimen}%
  \typeout{vsize: \the\vsize}%
  \typeout{pgflinewidth: \the\pgflinewidth}%
  % --- alle Dimensionen in nackte Zahlen (pt) umwandeln ---
  \edef\cvb@restpt{\strip@pt\resthoehe}%
  \edef\cvb@linept{\strip@pt\pgflinewidth}%
  \edef\cvb@boxpt{\strip@pt\dimexpr #1\relax}%
  % Schutz gegen 0 oder negative Boxhöhe
  \ifdim\dimexpr #1\relax>\z@
    \pgfmathtruncatemacro\anzahlv{(\cvb@restpt-\cvb@linept)/\cvb@boxpt}%
  \else
    \def\anzahlv{0}%
  \fi
  \typeout{anzahlv: \anzahlv}
  % Gewünschte Anzahl vs. mögliche Anzahl vergleichen
  \ifnum#2>\anzahlv\relax
    \PackageInfo{sty/2_General}{#2 Kaestchen gefordert, aber nur \anzahlv\space passen. Verwende \anzahlv.}%
    \edef\vertcount{\anzahlv}%
  \else
    \edef\vertcount{#2}%
  \fi
  \typeout{vertcount: \vertcount}
}

\renewcommand{\hinweis}[1]{
    \ifhints
        {\color{gray}\small \faInfoCircle~#1}
    \fi
}

\newcommand{\kariertSimple}[2][0.5cm]{% 
	\begin{tikzpicture}[darkgray,step=#1]
	\pgfmathtruncatemacro\anzahl{(\linewidth-\pgflinewidth)/#1} % maximale Anzahl Kästchen pro Zeile
	\draw (0,0) rectangle (\anzahl*#1,#2*#1) (0,0) grid (\anzahl*#1,#2*#1);
	\end{tikzpicture} 
}

% % Der neue Befehl, der alles steuert.
% \newcommand{\kariertFill}[1][0.5cm]{%
%     \par\nobreak % Wichtig für eine korrekte Messung des verbleibenden Platzes.
%     \stepdimen=#1 % Speichert die gewünschte Kästchengröße.
%     \directlua{fill_remaining_space_with_grid()}% Startet die Berechnung und Ausgabe.
% }

% \newdimen\stepdimen

% \begin{luacode*}
% function fill_remaining_space_with_grid()
%     -- 1. Verbleibenden Platz in Scaled Points (sp) berechnen.
%     local remaining_sp = tex.pagegoal - tex.pagetotal - tex.pagedepth
    
%     -- 2. Die Kästchengröße aus dem TeX-Register in sp auslesen.
%     local step_sp = tex.dimen.stepdimen
    
%     -- 3. Anzahl der möglichen Zeilen berechnen.
%     if step_sp > 0 then
%         local num_rows = math.floor(remaining_sp / step_sp)
%         num_rows=num_rows-5
        
%         -- 4. Den \kariertSimple-Befehl mit den korrekten Werten in den TeX-Code "drucken".
%         if num_rows > 0 then
%             tex.sprint(string.format([[\kariertSimple[\the\stepdimen]{%d}]], num_rows))
%         end
%     end
% end
% \end{luacode*}


\renewcommand\kariert[2][0.5cm]{%
  % Prüft, ob das zweite Argument #2 gleich 0 ist
  %\ifnum#2=0
    % if #2 == 0 then
  %  \kariertFill[#1]%
  %\else
    \kariertSimple[#1]{#2}%
  %\fi
}


% #1: counter
% #2: formatting command (e.g., \arabic, \roman)
\renewcommand{\ShowAndStepCounter}[2]{%
    {%
        #2{#1}%
        \stepcounter{#1}%
    }%
}



\renewcommand{\multi}{\item[$\circ$]}

\renewcommand\liniert[2][1.2cm]{% 
	\begin{tikzpicture}[gray]
	\path[use as bounding box](0,0)rectangle(\linewidth,-#2*#1-0.5\pgflinewidth); 
	\foreach \n in {1,...,#2}\draw(0 ,-#1*\n )--(\linewidth,-#1*\n ); 
	\end{tikzpicture}}

\lstset{
tabsize = 1, %% set tab space width
keywordstyle = \color{purple}, %% set keyword color
stringstyle = \color{green}, %% set string color
rulecolor = \color{\TFarbe}, %% set frame color to avoid being affected by text color
breaklines = true, %% enable line breaking
numberstyle = \footnotesize,
language = Java , 
firstnumber = last , 
escapeinside={(*@}{@*)}
}

\ifbeamer
	\hypersetup{
		colorlinks=true,
		linkcolor=white,
		filecolor=magenta,      
		urlcolor=Lavender,
		%pdftitle={\Titeltext},
	}
\else
	\hypersetup{
		colorlinks=true,
		linkcolor=blue,
		filecolor=magenta,      
		urlcolor=BlueViolet,
		%pdftitle={\Titeltext},
	}
\fi